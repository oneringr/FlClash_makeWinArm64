name: Build Windows ARM64

# 修改触发方式：
# 1. workflow_dispatch: 允许你在 GitHub 网页上手动点击按钮触发
# 2. push: 只要推送到 main 分支就触发
on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master

jobs:
  build-windows-arm64:
    name: Build Windows ARM64
    # 注意：如果你的 GitHub 账号不支持 windows-11-arm 原生运行器，
    # 可能需要改为 windows-latest，Flutter 支持从 x64 交叉编译到 arm64。
    # 这里为了保险，暂时沿用原项目的设置，如果运行失败请改为 windows-latest
    runs-on: windows-11-arm 
    
    steps:
      # 1. 拉取代码
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # 2. 配置 Rust 环境 (原项目针对 Windows ARM 的特定需求)
      - name: Setup Rust
        run: |
          Invoke-WebRequest -Uri "https://win.rustup.rs/aarch64" -OutFile rustup-init.exe
          .\rustup-init.exe -y --default-toolchain stable
          $cargoPath = "$env:USERPROFILE\.cargo\bin"
          Add-Content $env:GITHUB_PATH $cargoPath

      # 3. 配置 Go 环境
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.0'
          cache-dependency-path: core/go.sum

      # 4. 配置 Flutter 环境
      # 原项目逻辑：Windows ARM 版本使用 master 分支的 Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: master
          flutter-version: 3.35.7
          cache: true

      # 5. 安装 Flutter 依赖
      - name: Get Flutter Dependency
        run: |
          flutter --version
          flutter pub get

      # 6. 执行编译脚本
      # 强制指定 windows 和 arm64 架构
      - name: Build Application
        run: dart setup.dart windows --arch arm64

      # 7. 上传编译产物 (关键步骤)
      # 编译完成后，文件会出现在 GitHub Actions 页面的 Artifacts 栏目中
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: FlClash-Windows-ARM64
          path: ./dist
          overwrite: true
